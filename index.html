<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>韓文學習測驗</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
  body { font-family: Arial, sans-serif; padding: 20px; max-width: 400px; margin: 0 auto; }
    h1 { color: #2c3e50; }
    button { padding: 10px 20px; }
    .file-wrapper { padding-bottom: 10px; }
    .options-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 12px;
      width: 100%;
      margin: 16px 0;
    }
    .option {
      width: 100%;
      margin: 0;
      padding: 18px 0;
      border: 1px solid #aaa;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.1em;
      box-sizing: border-box;
      min-height: 48px;
    }
    .correct { background: #2ecc71; color: white; }
    .wrong { background: #e74c3c; color: white; }
    #stats { margin-top: 20px; }

    .cell-nowrap {
      white-space: nowrap;
    }

    /* RWD 響應式設計 */
    @media (max-width: 600px) {
      body { padding: 5vw; font-size: 4vw; max-width: 100vw; }
      h1 { font-size: 7vw; }
      h2, h3 { font-size: 5vw; }
      button, .option { font-size: 4vw; padding: 3vw 5vw; margin: 2vw 0; }
      table { font-size: 3.5vw; width: 100%; }
      #quiz, #stats { padding: 0; }
      #questionText span { font-size: 6vw !important; }
      th, td { padding: 2vw 1vw !important; }
      .option { width: 100%; box-sizing: border-box; min-height: 12vw; }
      .options-grid { gap: 3vw; }
    }
  </style>
</head>
<body>
  <h1>韓文</h1>

  <div class="file-wrapper">
    <label>上傳 CSV 檔案：</label>
    <input type="file" id="csvFile" accept=".csv">
    <div id="localDataInfo" style="color:#888; font-size: 12px;"></div>
  </div>

  <div>
    <button onclick="startQuiz('reading')">閱讀測驗</button>
    <button onclick="startQuiz('listening')">聽力測驗</button>
    <button onclick="startQuiz('spelling')">拼寫測驗</button>
    <button onclick="showSettings()">測驗設定</button>
    <button onclick="showVocabularyList()">單字表</button>
  </div>

  <hr>

  <div id="quiz" style="display:none;">
    <h2>題目</h2>
    <div style="margin-bottom:10px;">
      <label><input type="checkbox" id="wordCheckbox" checked> 單字</label>
      <label style="margin-left:10px;"><input type="checkbox" id="sentenceCheckbox" checked> 句子</label>
    </div>
    <div id="questionText"></div>
    <button id="audioBtn" onclick="playAudio()">🔊 播放韓文</button>
    <button onclick="nextQuestion()">下一題</button>
    <div id="options"></div>
    <div id="feedback"></div>
  </div>

  <div id="stats"></div>

  <script>
    let data = [];
    let mode = "";
    let readingType = "";
    let currentQuestion = null;
    // stats 依模式分開
    let stats = {
      reading: { total: 0, correct: 0, wrongWords: {} },
      listening: { total: 0, correct: 0, wrongWords: {} },
      spelling: { total: 0, correct: 0, wrongWords: {} }
    };
    // 取得目前模式的 stats
    function getCurrentStats() {
      return stats[mode] || { total: 0, correct: 0, wrongWords: {} };
    }



    // 顯示 localStorage 狀態
    function updateLocalDataInfo() {
      let info = '';
      if (data && data.length > 0) {
        info = `共 ${data.length} 個單字`;
      } else {
        info = '尚無單字，請匯入';
      }
      let el = document.getElementById('localDataInfo');
      if (el) el.textContent = info;
    }

    // 匯入 CSV 並存入 localStorage
    document.getElementById("csvFile").addEventListener("change", function (e) {
      Papa.parse(e.target.files[0], {
        complete: function(results) {
          data = results.data.slice(1); // 移除標題列
          // 儲存到 localStorage
          try {
            localStorage.setItem('koreanQuizData', JSON.stringify(data));
          } catch (err) {
            alert('localStorage 儲存失敗: ' + err);
          }
          updateLocalDataInfo();
          alert("CSV 讀取完成，共 " + data.length + " 筆資料");
        }
      });
    });

    // 載入 localStorage 資料
    function loadLocalData() {
      let local = localStorage.getItem('koreanQuizData');
      if (local) {
        try {
          data = JSON.parse(local);
        } catch (e) {
          data = [];
        }
      }
    }

    // 頁面載入時自動載入 localStorage
    window.addEventListener('DOMContentLoaded', function() {
      loadLocalData();
      updateLocalDataInfo();
      // 若無 localStorage 資料，提示上傳
      if (!data || data.length === 0) {
        alert('請先上傳 CSV 檔！');
      }
    });

    // 取得目前勾選的單字 index 陣列
    function getSelectedIndexes() {
      let selected = localStorage.getItem('koreanQuizSelected');
      if (!selected) return null;
      try {
        let arr = JSON.parse(selected);
        if (Array.isArray(arr)) return arr;
      } catch (e) {}
      return null;
    }

    // 設定目前勾選的單字 index 陣列
    function setSelectedIndexes(arr) {
      localStorage.setItem('koreanQuizSelected', JSON.stringify(arr));
    }

    function startQuiz(selectedMode) {
      if (data.length === 0) {
        alert("請先上傳 CSV 檔！");
        return;
      }
      // 只抽選有勾選的單字
      let selectedIndexes = getSelectedIndexes();
      if (selectedIndexes && selectedIndexes.length > 0) {
        window.quizPool = selectedIndexes.map(i => data[i]).filter(Boolean);
      } else {
        window.quizPool = data;
      }
      if (!window.quizPool || window.quizPool.length === 0) {
        alert('請先到「測驗設定」勾選要出題的單字！');
        return;
      }
      mode = selectedMode;
      document.getElementById("stats").innerHTML = "";
      document.getElementById("quiz").style.display = "block";
      // 若切換模式，初始化該模式的統計
      if (!stats[mode]) stats[mode] = { total: 0, correct: 0, wrongWords: {} };
      nextQuestion();
    }

    function nextQuestion() {
      // 中斷正在播放的語音
      if (window.speechSynthesis) speechSynthesis.cancel();
      // 取得 checkbox 狀態
      const wordChecked = document.getElementById("wordCheckbox")?.checked;
      const sentenceChecked = document.getElementById("sentenceCheckbox")?.checked;
      // 若都沒選，預設單字
      let types = [];
      if (wordChecked) types.push('word');
      if (sentenceChecked) types.push('sentence');
      if (types.length === 0) types = ['word'];
      // 隨機決定題型
      readingType = types[Math.floor(Math.random() * types.length)];

      // 只從 quizPool 抽題
      let pool = window.quizPool && window.quizPool.length > 0 ? window.quizPool : data;
      let idx = Math.floor(Math.random() * pool.length);
      currentQuestion = pool[idx];
      let correctAnswer;
      let questionText = "";
      let showAudioBtn = true;

      // 拼寫測驗模式
      if (mode === "spelling") {
        let inputHtml = '';
        if (readingType === 'word') {
          // 單字題：顯示中文，輸入韓文
          correctAnswer = currentQuestion[0];
          questionText = `<span style='font-size:1.2em;'>請輸入下列中文的韓文拼寫：</span><br><span style='font-size:1.5em;'>${currentQuestion[1]}</span>`;
          showAudioBtn = false;
          inputHtml = `<div class='spelling-row'><input id='spellingInput' type='text' style='font-size:1.5em; flex:1; margin:10px 0;'> <button onclick='submitSpelling()'>送出</button></div>`;
        } else {
          // 句子題：顯示挖空韓文
          let sentence = currentQuestion[2];
          let word = currentQuestion[0];
          let blanked = sentence.replace(word, '____');
          correctAnswer = word;
          questionText = `<span style='font-size:1.2em;'>請填入空格：</span><br><span style='font-size:1.5em;'>${blanked}</span>`;
          showAudioBtn = false;
          inputHtml = `<div class='spelling-row'><input id='spellingInput' type='text' style='font-size:1.5em; flex:1; margin:10px 0;'> <button style='white-space:nowrap;' onclick='submitSpelling()'>送出</button> <button type='button' style='white-space:nowrap;' onclick='replaySpellingAudio()'>再次播放</button></div>`;
          // 新增：自動語音念出挖空後的韓文句子
          setTimeout(function() {
            let sentence = currentQuestion[2];
            let utter = new SpeechSynthesisUtterance(sentence);
            utter.lang = "ko-KR";
            speechSynthesis.speak(utter);
          }, 200);
        }
        // 再次播放功能
        window.replaySpellingAudio = function() {
          if (readingType === 'word') {
            let word = currentQuestion[0];
            let utter = new SpeechSynthesisUtterance(word);
            utter.lang = "ko-KR";
            speechSynthesis.speak(utter);
          } else {
            let sentence = currentQuestion[2];
            let word = currentQuestion[0];
            let utter = new SpeechSynthesisUtterance(sentence);
            utter.lang = "ko-KR";
            speechSynthesis.speak(utter);
          }
        };
        document.getElementById("questionText").innerHTML = questionText + '<br>' + inputHtml;
        document.getElementById("questionText").style.display = "inline-block";
        document.getElementById("audioBtn").style.display = "none";
        document.getElementById("options").innerHTML = "";
        document.getElementById("feedback").innerText = "";
        // 注入拼寫測驗橫排樣式
        if (!document.getElementById('spelling-row-style')) {
          const style = document.createElement('style');
          style.id = 'spelling-row-style';
          style.innerHTML = `.spelling-row { display: flex; align-items: center; gap: 8px; width: 100%; }`;
          document.head.appendChild(style);
        }
        // 不自動播放語音
        // 按 Enter 送出
        let input = document.getElementById('spellingInput');
        if (input) {
          input.focus();
          input.onkeydown = function(e) { if (e.key === 'Enter') submitSpelling(); };
        }
        // 暫存正確答案
        window._spellingAnswer = correctAnswer;
        window._spellingQuestion = currentQuestion;
        window._spellingType = readingType;
        return;
      }

      // 其他模式（原本選擇題）
      if (readingType === 'word') {
        questionText = `<span style='font-size:2em;'>${currentQuestion[0]}</span>`;
        correctAnswer = currentQuestion[1];
      } else {
        questionText = `<span style='font-size:1.3em;'>${currentQuestion[2]}</span>`;
        correctAnswer = currentQuestion[3];
      }
      showAudioBtn = (mode === "listening"); // 聽力測驗才顯示播放按鈕

      // 顯示題目
      if (mode === "reading") document.getElementById("questionText").innerHTML = questionText;
      document.getElementById("questionText").style.display = showAudioBtn ? "none" : "inline-block";
      document.getElementById("audioBtn").style.display = showAudioBtn ? "inline-block" : "none";

      // 建立選項
      let options = [correctAnswer];
      while (options.length < 4) {
        let wrong = data[Math.floor(Math.random() * data.length)][(readingType === 'word') ? 1 : 3];
        if (!options.includes(wrong)) options.push(wrong);
      }
      options.sort(() => Math.random() - 0.5); // 打亂順序

      // 顯示選項
      let optionsDiv = document.getElementById("options");
      optionsDiv.innerHTML = "";
      // 建立 options-grid 容器
      let grid = document.createElement("div");
      grid.className = "options-grid";
      options.forEach(opt => {
        let btn = document.createElement("button");
        btn.className = "option";
        btn.textContent = opt;
        btn.onclick = () => checkAnswer(opt, correctAnswer, currentQuestion, readingType);
        grid.appendChild(btn);
      });
      optionsDiv.appendChild(grid);

      document.getElementById("feedback").innerText = "";
    }
    // 拼寫測驗送出答案
    function submitSpelling() {
      let input = document.getElementById('spellingInput');
      if (!input) return;
      let userAns = input.value.trim();
      let correct = window._spellingAnswer;
      let question = window._spellingQuestion;
      let type = window._spellingType;
      let curStats = getCurrentStats();
      curStats.total++;
      let feedback = document.getElementById("feedback");
      if (userAns === correct) {
        curStats.correct++;
        feedback.innerHTML = "<p style='color:green;'>✅ 正確！</p>";
      } else {
        feedback.innerHTML = `<p style='color:red;'>❌ 錯誤！ 正確答案是：<b>${correct}</b></p>`;
        let wordKey = question[0];
        curStats.wrongWords[wordKey] = (curStats.wrongWords[wordKey] || 0) + 1;
      }
      // 顯示詳細資訊
      let rows = [];
      rows.push(`<tr style=\"background:#99ee99;\">
        <td class="cell-nowrap" onclick=\"playSentenceAudio('${question[0]}')\">${question[0]}</td>
        <td class="cell-nowrap">${question[1]}</td>
        <td onclick=\"playSentenceAudio('${question[2]}')\">${question[2]}</td>
        <td>${question[3]}</td>
      </tr>`);
      feedback.innerHTML += `
        <table border=\"1\" cellpadding=\"5\" cellspacing=\"0\">
          <thead>
            <tr>
              <th class="cell-nowrap">韓文</th>
              <th class="cell-nowrap">中文</th>
              <th>韓文例句</th>
              <th>中文例句</th>
            </tr>
          </thead>
          <tbody>
            ${rows.join("")}
          </tbody>
        </table>
      `;
      // 送出後才播放正確答案（韓文）
      setTimeout(() => {
        let utter = new SpeechSynthesisUtterance(correct);
        utter.lang = "ko-KR";
        speechSynthesis.speak(utter);
      }, 200);
  updateStats();
      // 下一題
      setTimeout(nextQuestion, 1500);
    }

    function checkAnswer(selected, correct, question) {
      let curStats = getCurrentStats();
      curStats.total++;
      let feedback = document.getElementById("feedback");
      // 閱讀測驗自動語音念出題目
      if (mode === "reading") {
        let text = readingType === 'word' ? question[0] : question[2];
        if (text) {
          let utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = "ko-KR";
          speechSynthesis.speak(utterance);
        }
      }
      // 準備正確答案與選擇答案的 row
      let rows = [];
      // 決定正確答案 row
      let correctRow = question;
      rows.push(`<tr style=\"background:#99ee99;\">
        <td class="cell-nowrap" onclick=\"playSentenceAudio('${correctRow[0]}')\">${correctRow[0]}</td>
        <td class="cell-nowrap">${correctRow[1]}</td>
        <td onclick=\"playSentenceAudio('${correctRow[2]}')\">${correctRow[2]}</td>
        <td>${correctRow[3]}</td>
      </tr>`);
      // 如果選擇錯誤且選擇的不是正確答案，顯示選擇的 row
      if (selected !== correct) {
        // 找到選擇的資料列
        let selectedRow = null;
        let found;
        if (mode === "word" || (mode === "reading" && readingType === 'word')) {
          found = data.find(row => row[1] === selected);
        } else if (mode === "sentence" || (mode === "reading" && readingType === 'sentence')) {
          found = data.find(row => row[3] === selected);
        }
        if (found) selectedRow = found;
        if (selectedRow) {
          rows.push(`<tr style=\"background:#ee9999;\">
            <td class="cell-nowrap" onclick=\"playSentenceAudio('${selectedRow[0]}')\">${selectedRow[0]}</td>
            <td class="cell-nowrap">${selectedRow[1]}</td>
            <td onclick=\"playSentenceAudio('${selectedRow[2]}')\">${selectedRow[2]}</td>
            <td>${selectedRow[3]}</td>
          </tr>`);
        }
      }
      if (selected === correct) {
        curStats.correct++;
        feedback.innerHTML = "<p style='color:green;'>✅ 正確！</p>";
      } else {
        feedback.innerHTML = "<p style='color:red;'>❌ 錯誤！ 正確答案是：" + correct + "</p>";
        let wordKey = currentQuestion[0]; // 韓文字
        curStats.wrongWords[wordKey] = (curStats.wrongWords[wordKey] || 0) + 1;
      }
      feedback.innerHTML += `
        <table border=\"1\" cellpadding=\"5\" cellspacing=\"0\">
          <thead>
            <tr>
              <th>韓文</th>
              <th>中文</th>
              <th>韓文例句</th>
              <th>中文例句</th>
            </tr>
          </thead>
          <tbody>
            ${rows.join("")}
          </tbody>
        </table>
      `;
      updateStats();
      // setTimeout(nextQuestion, 1500);
    }

    function playAudio() {
      if (!currentQuestion) return;
      let text = (readingType === "word") ? currentQuestion[0] : currentQuestion[2];
      let utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "ko-KR";
      speechSynthesis.speak(utterance);
    }

    function playWordAudio(text) {
      let utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "ko-KR";
      speechSynthesis.speak(utterance);
    }

    function playSentenceAudio(text) {
      let utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "ko-KR";
      speechSynthesis.speak(utterance);
    }

    function playAllWordAudio() {
      if (data.length === 0) {
        alert("請先上傳 CSV 檔！");
        return;
      }
      let index = 0;
      // 取得所有單字表的 tr
      let rows = document.querySelectorAll("#stats table tbody tr");
      function highlightRow(idx) {
        rows.forEach((tr, i) => {
          if (i === idx) {
            tr.classList.add("playing");
          } else {
            tr.classList.remove("playing");
          }
        });
      }
      function playNext() {
        if (index < data.length) {
          highlightRow(index);
          let word = data[index][0];
          let chinese = data[index][1];
          let utterKorean = new SpeechSynthesisUtterance(word);
          utterKorean.lang = "ko-KR";
          utterKorean.onend = () => {
            // 播放中文，結束後再等 1 秒播放下一組
            let utterChinese = new SpeechSynthesisUtterance(chinese);
            utterChinese.lang = "zh-TW";
            utterChinese.onend = () => {
              index++;
              setTimeout(playNext, 1000);
            };
            speechSynthesis.speak(utterChinese);
          };
          speechSynthesis.speak(utterKorean);
        } else {
          highlightRow(-1); // 清除所有標示
        }
      }
      // 等待一秒後開始播放
      setTimeout(playNext, 1000);
    }

    function playAllSentenceAudio() {
      if (data.length === 0) {
        alert("請先上傳 CSV 檔！");
        return;
      }
      let index = 0;
      // 取得所有單字表的 tr
      let rows = document.querySelectorAll("#stats table tbody tr");
      function highlightRow(idx) {
        rows.forEach((tr, i) => {
          if (i === idx) {
            tr.classList.add("playing");
          } else {
            tr.classList.remove("playing");
          }
        });
      }
      function playNext() {
        if (index < data.length) {
          highlightRow(index);
          let sentence = data[index][2];
          let chinese = data[index][3];
          let utterKorean = new SpeechSynthesisUtterance(sentence);
          utterKorean.lang = "ko-KR";
          utterKorean.onend = () => {
            // 播放中文，結束後再等 1 秒播放下一組
            let utterChinese = new SpeechSynthesisUtterance(chinese);
            utterChinese.lang = "zh-TW";
            utterChinese.onend = () => {
              index++;
              setTimeout(playNext, 1000);
            };
            speechSynthesis.speak(utterChinese);
          };
          speechSynthesis.speak(utterKorean);
        } else {
          highlightRow(-1); // 清除所有標示
        }
      }
      // 等待一秒後開始播放
      setTimeout(playNext, 1000);
    }

    function stopAllAudio() {
      speechSynthesis.cancel();
      // 清除單字表播放標示
      let rows = document.querySelectorAll("#stats table tbody tr");
      rows.forEach(tr => tr.classList.remove("playing"));
    }

    function updateStats() {
      let curStats = getCurrentStats();
      let accuracy = curStats.total > 0 ? ((curStats.correct / curStats.total) * 100).toFixed(2) : '0.00';
      let modeName = '';
      if (mode === 'reading') modeName = '閱讀測驗';
      else if (mode === 'listening') modeName = '聽力測驗';
      else if (mode === 'spelling') modeName = '拼寫測驗';
      document.getElementById("stats").innerHTML = `
        <h3>${modeName}學習統計</h3>
        <p>答題數：${curStats.total}</p>
        <p>正確率：${accuracy}%</p>
        <p>錯誤字彙：</p>
        <ul>${Object.entries(curStats.wrongWords).map(([w, c]) => `<li>${w} - ${c} 次</li>`).join("")}</ul>
      `;
    }

    // 分頁狀態
    let vocabPage = 1;
    const vocabPageSize = 10;

    // 記憶 checkbox 與間隔秒數
    let vocabSettings = {
      loop: false,
      autoPage: false,
      interval: 0.5
    };

    function showVocabularyList(page = 1) {
      if (data.length === 0) {
        alert("請先上傳 CSV 檔！");
        return;
      }
      vocabPage = page;
      const totalPages = Math.ceil(data.length / vocabPageSize);
      const startIdx = (vocabPage - 1) * vocabPageSize;
      const endIdx = Math.min(startIdx + vocabPageSize, data.length);
      const pageData = data.slice(startIdx, endIdx);

      // 取用暫存設定
      let loopChecked = vocabSettings.loop ? 'checked' : '';
      let autoPageChecked = vocabSettings.autoPage ? 'checked' : '';
      let intervalValue = typeof vocabSettings.interval === 'number' ? vocabSettings.interval : 0.5;

      let vocabHtml = `
        <h2>單字表</h2>
        <div>
          <button onclick="playAllWordAudio(true)">播放單字</button>
          <button onclick="playAllSentenceAudio(true)">播放例句</button>
          <button onclick="stopAllAudio()">停止播放</button>
          <div style="margin:10px 0;">
            <label>
              <input type="checkbox" id="loopCheckbox" name="loopCheckbox" ${loopChecked}> 循環播放
            </label>
            <label style="margin-left:10px;">
              <input type="checkbox" id="autoPageCheckbox" name="autoPageCheckbox" ${autoPageChecked}> 自動換頁
            </label>
            <label style="margin-left:10px;">
              間隔時間：
              <input type="number" id="intervalInput" value="${intervalValue}" min="0" style="width:50px;"> 秒
            </label>
          </div>
        </div>
        <table border="1" cellpadding="5" cellspacing="0">
          <thead>
            <tr>
              <th class="cell-nowrap">韓文</th>
              <th class="cell-nowrap">中文</th>
              <th>韓文例句</th>
              <th>中文例句</th>
            </tr>
          </thead>
          <tbody>
            ${pageData.map(row => `
              <tr>
                <td class="cell-nowrap" onclick=\"playWordAudio('${row[0]}')\">${row[0]}</td>
                <td class="cell-nowrap">${row[1]}</td>
                <td onclick=\"playSentenceAudio('${row[2]}')\">${row[2]}</td>
                <td>${row[3]}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
        <div style='padding-top:10px; text-align: center;'>
          <button ${vocabPage === 1 ? 'disabled' : ''} onclick='saveVocabSettings();showVocabularyList(${vocabPage - 1})'>上一頁</button>
          第 ${vocabPage} / ${totalPages} 頁
          <button ${vocabPage === totalPages ? 'disabled' : ''} onclick='saveVocabSettings();showVocabularyList(${vocabPage + 1})'>下一頁</button>
        </div>
      `;
      document.getElementById("quiz").style.display = "none";
      document.getElementById("stats").innerHTML = vocabHtml;

      // 綁定 checkbox 與 input 事件，變動時即時存入暫存
      setTimeout(() => {
        let loopCheckbox = document.getElementById("loopCheckbox");
        let autoPageCheckbox = document.getElementById("autoPageCheckbox");
        let intervalInput = document.getElementById("intervalInput");
        if (loopCheckbox) loopCheckbox.onchange = saveVocabSettings;
        if (autoPageCheckbox) autoPageCheckbox.onchange = saveVocabSettings;
        if (intervalInput) intervalInput.oninput = saveVocabSettings;
      }, 0);
    }

    // 換頁前先存設定
    function saveVocabSettings() {
      let loopCheckbox = document.getElementById("loopCheckbox");
      let autoPageCheckbox = document.getElementById("autoPageCheckbox");
      let intervalInput = document.getElementById("intervalInput");
      vocabSettings.loop = loopCheckbox && loopCheckbox.checked;
      vocabSettings.autoPage = autoPageCheckbox && autoPageCheckbox.checked;
      let val = intervalInput && intervalInput.value ? parseFloat(intervalInput.value) : 0.5;
      vocabSettings.interval = (isNaN(val) || val < 0) ? 0.5 : val;
    }

    // 修改播放全部單字/例句，僅撥放當前頁
    function playAllWordAudio(onlyCurrentPage = false) {
      if (data.length === 0) {
        alert("請先上傳 CSV 檔！");
        return;
      }
      // 手機首次播放時先播放一段極短靜音語音以解鎖語音權限
      if (!window.speechSynthesisUnlocked) {
        let unlockUtter = new SpeechSynthesisUtterance(" ");
        unlockUtter.volume = 0;
        unlockUtter.rate = 10;
        unlockUtter.onend = () => {
          window.speechSynthesisUnlocked = true;
          playAllWordAudio(onlyCurrentPage);
        };
        speechSynthesis.speak(unlockUtter);
        return;
      }
      let pageData, rows;
      let autoPage = false;
      let autoPageCheckbox = document.getElementById("autoPageCheckbox");
      if (autoPageCheckbox) autoPage = autoPageCheckbox.checked;
      if (onlyCurrentPage) {
        const startIdx = (vocabPage - 1) * vocabPageSize;
        const endIdx = Math.min(startIdx + vocabPageSize, data.length);
        pageData = data.slice(startIdx, endIdx);
        // 只選取當前頁的 tr
        rows = Array.from(document.querySelectorAll("#stats table tbody tr")).slice(0, pageData.length);
      } else {
        pageData = data;
        rows = document.querySelectorAll("#stats table tbody tr");
      }
      let index = 0;
      // 取得循環播放勾選狀態
      let loop = false;
      let loopCheckbox = document.getElementById("loopCheckbox");
      if (loopCheckbox) loop = loopCheckbox.checked;
      // 取得間隔秒數
      let intervalInput = document.getElementById("intervalInput");
      let intervalSec = intervalInput ? parseFloat(intervalInput.value) : 1;
      if (isNaN(intervalSec) || intervalSec < 0) intervalSec = 1;
      let intervalMs = intervalSec * 1000;
      function highlightRow(idx) {
        rows.forEach((tr, i) => {
          if (i === idx) {
            tr.classList.add("playing");
          } else {
            tr.classList.remove("playing");
          }
        });
      }
      function playNext() {
        if (index < pageData.length) {
          highlightRow(index);
          let word = pageData[index][0];
          let chinese = pageData[index][1];
          let utterKorean = new SpeechSynthesisUtterance(word);
          utterKorean.lang = "ko-KR";
          utterKorean.onend = () => {
            let utterChinese = new SpeechSynthesisUtterance(chinese);
            utterChinese.lang = "zh-TW";
            utterChinese.onend = () => {
              index++;
              setTimeout(playNext, intervalMs);
            };
            speechSynthesis.speak(utterChinese);
          };
          speechSynthesis.speak(utterKorean);
        } else {
          highlightRow(-1);
          // 自動換頁
          if (autoPage && onlyCurrentPage) {
            const totalPages = Math.ceil(data.length / vocabPageSize);
            if (vocabPage < totalPages) {
              showVocabularyList(vocabPage + 1);
              setTimeout(() => playAllWordAudio(true), intervalMs + 200);
            } else if (loop) {
              showVocabularyList(1);
              setTimeout(() => playAllWordAudio(true), intervalMs + 200);
            }
            // 若最後一頁且未勾選循環則停止
          } else if (loop) {
            index = 0;
            setTimeout(playNext, intervalMs);
          }
        }
      }
      setTimeout(playNext, intervalMs);
    }

    function playAllSentenceAudio(onlyCurrentPage = false) {
      if (data.length === 0) {
        alert("請先上傳 CSV 檔！");
        return;
      }
      // 手機首次播放時先播放一段極短靜音語音以解鎖語音權限
      if (!window.speechSynthesisUnlocked) {
        let unlockUtter = new SpeechSynthesisUtterance(" ");
        unlockUtter.volume = 0;
        unlockUtter.rate = 10;
        unlockUtter.onend = () => {
          window.speechSynthesisUnlocked = true;
          playAllSentenceAudio(onlyCurrentPage);
        };
        speechSynthesis.speak(unlockUtter);
        return;
      }
      let pageData, rows;
      let autoPage = false;
      let autoPageCheckbox = document.getElementById("autoPageCheckbox");
      if (autoPageCheckbox) autoPage = autoPageCheckbox.checked;
      if (onlyCurrentPage) {
        const startIdx = (vocabPage - 1) * vocabPageSize;
        const endIdx = Math.min(startIdx + vocabPageSize, data.length);
        pageData = data.slice(startIdx, endIdx);
        // 只選取當前頁的 tr
        rows = Array.from(document.querySelectorAll("#stats table tbody tr")).slice(0, pageData.length);
      } else {
        pageData = data;
        rows = document.querySelectorAll("#stats table tbody tr");
      }
      let index = 0;
      // 取得循環播放勾選狀態
      let loop = false;
      let loopCheckbox = document.getElementById("loopCheckbox");
      if (loopCheckbox) loop = loopCheckbox.checked;
      // 取得間隔秒數
      let intervalInput = document.getElementById("intervalInput");
      let intervalSec = intervalInput ? parseFloat(intervalInput.value) : 1;
      if (isNaN(intervalSec) || intervalSec < 0) intervalSec = 1;
      let intervalMs = intervalSec * 1000;
      function highlightRow(idx) {
        rows.forEach((tr, i) => {
          if (i === idx) {
            tr.classList.add("playing");
          } else {
            tr.classList.remove("playing");
          }
        });
      }
      function playNext() {
        if (index < pageData.length) {
          highlightRow(index);
          let sentence = pageData[index][2];
          let chinese = pageData[index][3];
          let utterKorean = new SpeechSynthesisUtterance(sentence);
          utterKorean.lang = "ko-KR";
          utterKorean.onend = () => {
            let utterChinese = new SpeechSynthesisUtterance(chinese);
            utterChinese.lang = "zh-TW";
            utterChinese.onend = () => {
              index++;
              setTimeout(playNext, intervalMs);
            };
            speechSynthesis.speak(utterChinese);
          };
          speechSynthesis.speak(utterKorean);
        } else {
          highlightRow(-1);
          // 自動換頁
          if (autoPage && onlyCurrentPage) {
            const totalPages = Math.ceil(data.length / vocabPageSize);
            if (vocabPage < totalPages) {
              showVocabularyList(vocabPage + 1);
              setTimeout(() => playAllSentenceAudio(true), intervalMs + 200);
            } else if (loop) {
              showVocabularyList(1);
              setTimeout(() => playAllSentenceAudio(true), intervalMs + 200);
            }
            // 若最後一頁且未勾選循環則停止
          } else if (loop) {
            index = 0;
            setTimeout(playNext, intervalMs);
          }
        }
      }
      setTimeout(playNext, intervalMs);
    }

    // 樣式：正在播放的 tr
    const style = document.createElement('style');
    style.innerHTML = `.playing { background: #ffe066 !important; }`;
    document.head.appendChild(style);

    // 測驗設定頁：分頁顯示單字，支援全選/單選，記錄勾選狀態
    let settingsPage = 1;
    const settingsPageSize = 10;
    function showSettings(page = 1) {
      if (data.length === 0) {
        alert("請先上傳 CSV 檔！");
        return;
      }
      settingsPage = page;
      const totalPages = Math.ceil(data.length / settingsPageSize);
      const startIdx = (settingsPage - 1) * settingsPageSize;
      const endIdx = Math.min(startIdx + settingsPageSize, data.length);
      const pageData = data.slice(startIdx, endIdx);
      // 取得已勾選 index
      let selectedIndexes = getSelectedIndexes() || [];
      // 本頁所有 index
      let pageIndexes = Array.from({length: endIdx - startIdx}, (_, i) => startIdx + i);
      // 判斷本頁是否全選
      let allChecked = pageIndexes.every(i => selectedIndexes.includes(i));
      let settingsHtml = `
        <h2>測驗設定</h2>
        <div style="margin-bottom:10px; color:#666;">
          勾選的單字才會出現在測驗題目中
          <span style='color:#888; font-size:13px;'>(全部未勾選視為全選)</span>
        </div>
        <div>
          <label>
            <input type="checkbox" id="selectAllCheckbox" ${allChecked ? 'checked' : ''} onclick="toggleSelectAll(this.checked)"> 選取所有單字
          </label>
        </div>
        <table border="1" cellpadding="5" cellspacing="0" style="width:100%;">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAllCheckbox" ${allChecked ? 'checked' : ''} onclick="toggleSelectAllOnPage(this.checked)"></th>
              <th class="cell-nowrap">韓文</th>
              <th class="cell-nowrap">中文</th>
              <th>韓文例句</th>
              <th>中文例句</th>
            </tr>
          </thead>
          <tbody>
            ${pageData.map((row, idx) => {
              let globalIdx = startIdx + idx;
              let checked = selectedIndexes.includes(globalIdx) ? 'checked' : '';
              return `<tr>
                <td><input type='checkbox' class='wordCheckboxSetting' data-idx='${globalIdx}' ${checked}></td>
                <td class="cell-nowrap">${row[0]}</td>
                <td class="cell-nowrap">${row[1]}</td>
                <td>${row[2]}</td>
                <td>${row[3]}</td>
              </tr>`;
            }).join("")}
          </tbody>
        </table>
        <div style='padding-top:10px; text-align: center;'>
          <button ${settingsPage === 1 ? 'disabled' : ''} onclick='showSettings(${settingsPage - 1})'>上一頁</button>
          第 ${settingsPage} / ${totalPages} 頁
          <button ${settingsPage === totalPages ? 'disabled' : ''} onclick='showSettings(${settingsPage + 1})'>下一頁</button>
        </div>
      `;
      document.getElementById("quiz").style.display = "none";
      document.getElementById("stats").innerHTML = settingsHtml;
      // 綁定 checkbox 事件
      setTimeout(() => {
        let boxes = document.querySelectorAll('.wordCheckboxSetting');
        boxes.forEach(box => {
          box.onchange = function() {
            let idx = parseInt(this.getAttribute('data-idx'));
            let arr = getSelectedIndexes() || [];
            if (this.checked) {
              if (!arr.includes(idx)) arr.push(idx);
            } else {
              arr = arr.filter(i => i !== idx);
            }
            setSelectedIndexes(arr);
            // 更新全選狀態
            let pageIndexes = Array.from({length: endIdx - startIdx}, (_, i) => startIdx + i);
            let allChecked = pageIndexes.every(i => arr.includes(i));
            let selectAll = document.getElementById('selectAllCheckbox');
            if (selectAll) selectAll.checked = allChecked;
          };
        });
      }, 0);


      // 全選切換
      window.toggleSelectAll = function(checked) {
        if (checked) {
          // 全選所有 index
          let allIndexes = Array.from({length: data.length}, (_, i) => i);
          setSelectedIndexes(allIndexes);
        } else {
          // 清空所有勾選
          setSelectedIndexes([]);
        }
        // 更新本頁所有 checkbox
        let boxes = document.querySelectorAll('.wordCheckboxSetting');
        boxes.forEach(box => { box.checked = checked; });
      };
      window.toggleSelectAllOnPage = function(checked) {
        let arr = getSelectedIndexes() || [];
        let pageIndexes = Array.from({length: endIdx - startIdx}, (_, i) => startIdx + i);
        if (checked) {
          pageIndexes.forEach(i => { if (!arr.includes(i)) arr.push(i); });
        } else {
          arr = arr.filter(i => !pageIndexes.includes(i));
        }
        setSelectedIndexes(arr);
        // 更新本頁所有 checkbox
        let boxes = document.querySelectorAll('.wordCheckboxSetting');
        boxes.forEach(box => { box.checked = checked; });
      };
    }
  </script>
</body>
</html>
