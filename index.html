<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>éŸ“æ–‡å­¸ç¿’æ¸¬é©—</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
  body { font-family: Arial, sans-serif; padding: 20px; max-width: 400px; margin: 0 auto; }
    h1 { color: #2c3e50; }
    button { padding: 10px 20px; }
    .file-wrapper { padding-bottom: 10px; }
    .options-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 12px;
      width: 100%;
      margin: 16px 0;
    }
    .option {
      width: 100%;
      margin: 0;
      padding: 18px 0;
      border: 1px solid #aaa;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.1em;
      box-sizing: border-box;
      min-height: 48px;
    }
    .correct { background: #2ecc71; color: white; }
    .wrong { background: #e74c3c; color: white; }
    #stats { margin-top: 20px; }

    .cell-nowrap {
      white-space: nowrap;
    }

    /* RWD éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 600px) {
      body { padding: 5vw; font-size: 4vw; max-width: 100vw; }
      h1 { font-size: 7vw; }
      h2, h3 { font-size: 5vw; }
      button, .option { font-size: 4vw; padding: 3vw 5vw; margin: 2vw 0; }
      table { font-size: 3.5vw; width: 100%; }
      #quiz, #stats { padding: 0; }
      #questionText span { font-size: 6vw !important; }
      th, td { padding: 2vw 1vw !important; }
      .option { width: 100%; box-sizing: border-box; min-height: 12vw; }
      .options-grid { gap: 3vw; }
    }
  </style>
</head>
<body>
  <h1>éŸ“æ–‡</h1>

  <div class="file-wrapper">
    <label>ä¸Šå‚³ CSV æª”æ¡ˆï¼š</label>
    <input type="file" id="csvFile" accept=".csv">
    <div id="localDataInfo" style="color:#888; font-size: 12px;"></div>
  </div>

  <div>
    <button onclick="startQuiz('reading')">é–±è®€æ¸¬é©—</button>
    <button onclick="startQuiz('listening')">è½åŠ›æ¸¬é©—</button>
    <button onclick="startQuiz('spelling')">æ‹¼å¯«æ¸¬é©—</button>
    <button onclick="showSettings()">æ¸¬é©—è¨­å®š</button>
    <button onclick="showVocabularyList()">å–®å­—è¡¨</button>
  </div>

  <hr>

  <div id="quiz" style="display:none;">
    <h2>é¡Œç›®</h2>
    <div style="margin-bottom:10px;">
      <label><input type="checkbox" id="wordCheckbox" checked> å–®å­—</label>
      <label style="margin-left:10px;"><input type="checkbox" id="sentenceCheckbox" checked> å¥å­</label>
    </div>
    <div id="questionText"></div>
    <button id="audioBtn" onclick="playAudio()">ğŸ”Š æ’­æ”¾éŸ“æ–‡</button>
    <button onclick="nextQuestion()">ä¸‹ä¸€é¡Œ</button>
    <div id="options"></div>
    <div id="feedback"></div>
  </div>

  <div id="stats"></div>

  <script>
    let data = [];
    let mode = "";
    let readingType = "";
    let currentQuestion = null;
    // stats ä¾æ¨¡å¼åˆ†é–‹
    let stats = {
      reading: { total: 0, correct: 0, wrongWords: {} },
      listening: { total: 0, correct: 0, wrongWords: {} },
      spelling: { total: 0, correct: 0, wrongWords: {} }
    };
    // å–å¾—ç›®å‰æ¨¡å¼çš„ stats
    function getCurrentStats() {
      return stats[mode] || { total: 0, correct: 0, wrongWords: {} };
    }



    // é¡¯ç¤º localStorage ç‹€æ…‹
    function updateLocalDataInfo() {
      let info = '';
      if (data && data.length > 0) {
        info = `å…± ${data.length} å€‹å–®å­—`;
      } else {
        info = 'å°šç„¡å–®å­—ï¼Œè«‹åŒ¯å…¥';
      }
      let el = document.getElementById('localDataInfo');
      if (el) el.textContent = info;
    }

    // åŒ¯å…¥ CSV ä¸¦å­˜å…¥ localStorage
    document.getElementById("csvFile").addEventListener("change", function (e) {
      Papa.parse(e.target.files[0], {
        complete: function(results) {
          data = results.data.slice(1); // ç§»é™¤æ¨™é¡Œåˆ—
          // å„²å­˜åˆ° localStorage
          try {
            localStorage.setItem('koreanQuizData', JSON.stringify(data));
          } catch (err) {
            alert('localStorage å„²å­˜å¤±æ•—: ' + err);
          }
          updateLocalDataInfo();
          alert("CSV è®€å–å®Œæˆï¼Œå…± " + data.length + " ç­†è³‡æ–™");
        }
      });
    });

    // è¼‰å…¥ localStorage è³‡æ–™
    function loadLocalData() {
      let local = localStorage.getItem('koreanQuizData');
      if (local) {
        try {
          data = JSON.parse(local);
        } catch (e) {
          data = [];
        }
      }
    }

    // é é¢è¼‰å…¥æ™‚è‡ªå‹•è¼‰å…¥ localStorage
    window.addEventListener('DOMContentLoaded', function() {
      loadLocalData();
      updateLocalDataInfo();
      // è‹¥ç„¡ localStorage è³‡æ–™ï¼Œæç¤ºä¸Šå‚³
      if (!data || data.length === 0) {
        alert('è«‹å…ˆä¸Šå‚³ CSV æª”ï¼');
      }
    });

    // å–å¾—ç›®å‰å‹¾é¸çš„å–®å­— index é™£åˆ—
    function getSelectedIndexes() {
      let selected = localStorage.getItem('koreanQuizSelected');
      if (!selected) return null;
      try {
        let arr = JSON.parse(selected);
        if (Array.isArray(arr)) return arr;
      } catch (e) {}
      return null;
    }

    // è¨­å®šç›®å‰å‹¾é¸çš„å–®å­— index é™£åˆ—
    function setSelectedIndexes(arr) {
      localStorage.setItem('koreanQuizSelected', JSON.stringify(arr));
    }

    function startQuiz(selectedMode) {
      if (data.length === 0) {
        alert("è«‹å…ˆä¸Šå‚³ CSV æª”ï¼");
        return;
      }
      // åªæŠ½é¸æœ‰å‹¾é¸çš„å–®å­—
      let selectedIndexes = getSelectedIndexes();
      if (selectedIndexes && selectedIndexes.length > 0) {
        window.quizPool = selectedIndexes.map(i => data[i]).filter(Boolean);
      } else {
        window.quizPool = data;
      }
      if (!window.quizPool || window.quizPool.length === 0) {
        alert('è«‹å…ˆåˆ°ã€Œæ¸¬é©—è¨­å®šã€å‹¾é¸è¦å‡ºé¡Œçš„å–®å­—ï¼');
        return;
      }
      mode = selectedMode;
      document.getElementById("stats").innerHTML = "";
      document.getElementById("quiz").style.display = "block";
      // è‹¥åˆ‡æ›æ¨¡å¼ï¼Œåˆå§‹åŒ–è©²æ¨¡å¼çš„çµ±è¨ˆ
      if (!stats[mode]) stats[mode] = { total: 0, correct: 0, wrongWords: {} };
      nextQuestion();
    }

    function nextQuestion() {
      // ä¸­æ–·æ­£åœ¨æ’­æ”¾çš„èªéŸ³
      if (window.speechSynthesis) speechSynthesis.cancel();
      // å–å¾— checkbox ç‹€æ…‹
      const wordChecked = document.getElementById("wordCheckbox")?.checked;
      const sentenceChecked = document.getElementById("sentenceCheckbox")?.checked;
      // è‹¥éƒ½æ²’é¸ï¼Œé è¨­å–®å­—
      let types = [];
      if (wordChecked) types.push('word');
      if (sentenceChecked) types.push('sentence');
      if (types.length === 0) types = ['word'];
      // éš¨æ©Ÿæ±ºå®šé¡Œå‹
      readingType = types[Math.floor(Math.random() * types.length)];

      // åªå¾ quizPool æŠ½é¡Œ
      let pool = window.quizPool && window.quizPool.length > 0 ? window.quizPool : data;
      let idx = Math.floor(Math.random() * pool.length);
      currentQuestion = pool[idx];
      let correctAnswer;
      let questionText = "";
      let showAudioBtn = true;

      // æ‹¼å¯«æ¸¬é©—æ¨¡å¼
      if (mode === "spelling") {
        let inputHtml = '';
        if (readingType === 'word') {
          // å–®å­—é¡Œï¼šé¡¯ç¤ºä¸­æ–‡ï¼Œè¼¸å…¥éŸ“æ–‡
          correctAnswer = currentQuestion[0];
          questionText = `<span style='font-size:1.2em;'>è«‹è¼¸å…¥ä¸‹åˆ—ä¸­æ–‡çš„éŸ“æ–‡æ‹¼å¯«ï¼š</span><br><span style='font-size:1.5em;'>${currentQuestion[1]}</span>`;
          showAudioBtn = false;
          inputHtml = `<div class='spelling-row'><input id='spellingInput' type='text' style='font-size:1.5em; flex:1; margin:10px 0;'> <button onclick='submitSpelling()'>é€å‡º</button></div>`;
        } else {
          // å¥å­é¡Œï¼šé¡¯ç¤ºæŒ–ç©ºéŸ“æ–‡
          let sentence = currentQuestion[2];
          let word = currentQuestion[0];
          let blanked = sentence.replace(word, '____');
          correctAnswer = word;
          questionText = `<span style='font-size:1.2em;'>è«‹å¡«å…¥ç©ºæ ¼ï¼š</span><br><span style='font-size:1.5em;'>${blanked}</span>`;
          showAudioBtn = false;
          inputHtml = `<div class='spelling-row'><input id='spellingInput' type='text' style='font-size:1.5em; flex:1; margin:10px 0;'> <button style='white-space:nowrap;' onclick='submitSpelling()'>é€å‡º</button> <button type='button' style='white-space:nowrap;' onclick='replaySpellingAudio()'>å†æ¬¡æ’­æ”¾</button></div>`;
          // æ–°å¢ï¼šè‡ªå‹•èªéŸ³å¿µå‡ºæŒ–ç©ºå¾Œçš„éŸ“æ–‡å¥å­
          setTimeout(function() {
            let sentence = currentQuestion[2];
            let utter = new SpeechSynthesisUtterance(sentence);
            utter.lang = "ko-KR";
            speechSynthesis.speak(utter);
          }, 200);
        }
        // å†æ¬¡æ’­æ”¾åŠŸèƒ½
        window.replaySpellingAudio = function() {
          if (readingType === 'word') {
            let word = currentQuestion[0];
            let utter = new SpeechSynthesisUtterance(word);
            utter.lang = "ko-KR";
            speechSynthesis.speak(utter);
          } else {
            let sentence = currentQuestion[2];
            let word = currentQuestion[0];
            let utter = new SpeechSynthesisUtterance(sentence);
            utter.lang = "ko-KR";
            speechSynthesis.speak(utter);
          }
        };
        document.getElementById("questionText").innerHTML = questionText + '<br>' + inputHtml;
        document.getElementById("questionText").style.display = "inline-block";
        document.getElementById("audioBtn").style.display = "none";
        document.getElementById("options").innerHTML = "";
        document.getElementById("feedback").innerText = "";
        // æ³¨å…¥æ‹¼å¯«æ¸¬é©—æ©«æ’æ¨£å¼
        if (!document.getElementById('spelling-row-style')) {
          const style = document.createElement('style');
          style.id = 'spelling-row-style';
          style.innerHTML = `.spelling-row { display: flex; align-items: center; gap: 8px; width: 100%; }`;
          document.head.appendChild(style);
        }
        // ä¸è‡ªå‹•æ’­æ”¾èªéŸ³
        // æŒ‰ Enter é€å‡º
        let input = document.getElementById('spellingInput');
        if (input) {
          input.focus();
          input.onkeydown = function(e) { if (e.key === 'Enter') submitSpelling(); };
        }
        // æš«å­˜æ­£ç¢ºç­”æ¡ˆ
        window._spellingAnswer = correctAnswer;
        window._spellingQuestion = currentQuestion;
        window._spellingType = readingType;
        return;
      }

      // å…¶ä»–æ¨¡å¼ï¼ˆåŸæœ¬é¸æ“‡é¡Œï¼‰
      if (readingType === 'word') {
        questionText = `<span style='font-size:2em;'>${currentQuestion[0]}</span>`;
        correctAnswer = currentQuestion[1];
      } else {
        questionText = `<span style='font-size:1.3em;'>${currentQuestion[2]}</span>`;
        correctAnswer = currentQuestion[3];
      }
      showAudioBtn = (mode === "listening"); // è½åŠ›æ¸¬é©—æ‰é¡¯ç¤ºæ’­æ”¾æŒ‰éˆ•

      // é¡¯ç¤ºé¡Œç›®
      if (mode === "reading") document.getElementById("questionText").innerHTML = questionText;
      document.getElementById("questionText").style.display = showAudioBtn ? "none" : "inline-block";
      document.getElementById("audioBtn").style.display = showAudioBtn ? "inline-block" : "none";

      // å»ºç«‹é¸é …
      let options = [correctAnswer];
      while (options.length < 4) {
        let wrong = data[Math.floor(Math.random() * data.length)][(readingType === 'word') ? 1 : 3];
        if (!options.includes(wrong)) options.push(wrong);
      }
      options.sort(() => Math.random() - 0.5); // æ‰“äº‚é †åº

      // é¡¯ç¤ºé¸é …
      let optionsDiv = document.getElementById("options");
      optionsDiv.innerHTML = "";
      // å»ºç«‹ options-grid å®¹å™¨
      let grid = document.createElement("div");
      grid.className = "options-grid";
      options.forEach(opt => {
        let btn = document.createElement("button");
        btn.className = "option";
        btn.textContent = opt;
        btn.onclick = () => checkAnswer(opt, correctAnswer, currentQuestion, readingType);
        grid.appendChild(btn);
      });
      optionsDiv.appendChild(grid);

      document.getElementById("feedback").innerText = "";
    }
    // æ‹¼å¯«æ¸¬é©—é€å‡ºç­”æ¡ˆ
    function submitSpelling() {
      let input = document.getElementById('spellingInput');
      if (!input) return;
      let userAns = input.value.trim();
      let correct = window._spellingAnswer;
      let question = window._spellingQuestion;
      let type = window._spellingType;
      let curStats = getCurrentStats();
      curStats.total++;
      let feedback = document.getElementById("feedback");
      if (userAns === correct) {
        curStats.correct++;
        feedback.innerHTML = "<p style='color:green;'>âœ… æ­£ç¢ºï¼</p>";
      } else {
        feedback.innerHTML = `<p style='color:red;'>âŒ éŒ¯èª¤ï¼ æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š<b>${correct}</b></p>`;
        let wordKey = question[0];
        curStats.wrongWords[wordKey] = (curStats.wrongWords[wordKey] || 0) + 1;
      }
      // é¡¯ç¤ºè©³ç´°è³‡è¨Š
      let rows = [];
      rows.push(`<tr style=\"background:#99ee99;\">
        <td class="cell-nowrap" onclick=\"playSentenceAudio('${question[0]}')\">${question[0]}</td>
        <td class="cell-nowrap">${question[1]}</td>
        <td onclick=\"playSentenceAudio('${question[2]}')\">${question[2]}</td>
        <td>${question[3]}</td>
      </tr>`);
      feedback.innerHTML += `
        <table border=\"1\" cellpadding=\"5\" cellspacing=\"0\">
          <thead>
            <tr>
              <th class="cell-nowrap">éŸ“æ–‡</th>
              <th class="cell-nowrap">ä¸­æ–‡</th>
              <th>éŸ“æ–‡ä¾‹å¥</th>
              <th>ä¸­æ–‡ä¾‹å¥</th>
            </tr>
          </thead>
          <tbody>
            ${rows.join("")}
          </tbody>
        </table>
      `;
      // é€å‡ºå¾Œæ‰æ’­æ”¾æ­£ç¢ºç­”æ¡ˆï¼ˆéŸ“æ–‡ï¼‰
      setTimeout(() => {
        let utter = new SpeechSynthesisUtterance(correct);
        utter.lang = "ko-KR";
        speechSynthesis.speak(utter);
      }, 200);
  updateStats();
      // ä¸‹ä¸€é¡Œ
      setTimeout(nextQuestion, 1500);
    }

    function checkAnswer(selected, correct, question) {
      let curStats = getCurrentStats();
      curStats.total++;
      let feedback = document.getElementById("feedback");
      // é–±è®€æ¸¬é©—è‡ªå‹•èªéŸ³å¿µå‡ºé¡Œç›®
      if (mode === "reading") {
        let text = readingType === 'word' ? question[0] : question[2];
        if (text) {
          let utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = "ko-KR";
          speechSynthesis.speak(utterance);
        }
      }
      // æº–å‚™æ­£ç¢ºç­”æ¡ˆèˆ‡é¸æ“‡ç­”æ¡ˆçš„ row
      let rows = [];
      // æ±ºå®šæ­£ç¢ºç­”æ¡ˆ row
      let correctRow = question;
      rows.push(`<tr style=\"background:#99ee99;\">
        <td class="cell-nowrap" onclick=\"playSentenceAudio('${correctRow[0]}')\">${correctRow[0]}</td>
        <td class="cell-nowrap">${correctRow[1]}</td>
        <td onclick=\"playSentenceAudio('${correctRow[2]}')\">${correctRow[2]}</td>
        <td>${correctRow[3]}</td>
      </tr>`);
      // å¦‚æœé¸æ“‡éŒ¯èª¤ä¸”é¸æ“‡çš„ä¸æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Œé¡¯ç¤ºé¸æ“‡çš„ row
      if (selected !== correct) {
        // æ‰¾åˆ°é¸æ“‡çš„è³‡æ–™åˆ—
        let selectedRow = null;
        let found;
        if (mode === "word" || (mode === "reading" && readingType === 'word')) {
          found = data.find(row => row[1] === selected);
        } else if (mode === "sentence" || (mode === "reading" && readingType === 'sentence')) {
          found = data.find(row => row[3] === selected);
        }
        if (found) selectedRow = found;
        if (selectedRow) {
          rows.push(`<tr style=\"background:#ee9999;\">
            <td class="cell-nowrap" onclick=\"playSentenceAudio('${selectedRow[0]}')\">${selectedRow[0]}</td>
            <td class="cell-nowrap">${selectedRow[1]}</td>
            <td onclick=\"playSentenceAudio('${selectedRow[2]}')\">${selectedRow[2]}</td>
            <td>${selectedRow[3]}</td>
          </tr>`);
        }
      }
      if (selected === correct) {
        curStats.correct++;
        feedback.innerHTML = "<p style='color:green;'>âœ… æ­£ç¢ºï¼</p>";
      } else {
        feedback.innerHTML = "<p style='color:red;'>âŒ éŒ¯èª¤ï¼ æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š" + correct + "</p>";
        let wordKey = currentQuestion[0]; // éŸ“æ–‡å­—
        curStats.wrongWords[wordKey] = (curStats.wrongWords[wordKey] || 0) + 1;
      }
      feedback.innerHTML += `
        <table border=\"1\" cellpadding=\"5\" cellspacing=\"0\">
          <thead>
            <tr>
              <th>éŸ“æ–‡</th>
              <th>ä¸­æ–‡</th>
              <th>éŸ“æ–‡ä¾‹å¥</th>
              <th>ä¸­æ–‡ä¾‹å¥</th>
            </tr>
          </thead>
          <tbody>
            ${rows.join("")}
          </tbody>
        </table>
      `;
      updateStats();
      // setTimeout(nextQuestion, 1500);
    }

    function playAudio() {
      if (!currentQuestion) return;
      let text = (readingType === "word") ? currentQuestion[0] : currentQuestion[2];
      let utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "ko-KR";
      speechSynthesis.speak(utterance);
    }

    function playWordAudio(text) {
      let utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "ko-KR";
      speechSynthesis.speak(utterance);
    }

    function playSentenceAudio(text) {
      let utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "ko-KR";
      speechSynthesis.speak(utterance);
    }

    function playAllWordAudio() {
      if (data.length === 0) {
        alert("è«‹å…ˆä¸Šå‚³ CSV æª”ï¼");
        return;
      }
      let index = 0;
      // å–å¾—æ‰€æœ‰å–®å­—è¡¨çš„ tr
      let rows = document.querySelectorAll("#stats table tbody tr");
      function highlightRow(idx) {
        rows.forEach((tr, i) => {
          if (i === idx) {
            tr.classList.add("playing");
          } else {
            tr.classList.remove("playing");
          }
        });
      }
      function playNext() {
        if (index < data.length) {
          highlightRow(index);
          let word = data[index][0];
          let chinese = data[index][1];
          let utterKorean = new SpeechSynthesisUtterance(word);
          utterKorean.lang = "ko-KR";
          utterKorean.onend = () => {
            // æ’­æ”¾ä¸­æ–‡ï¼ŒçµæŸå¾Œå†ç­‰ 1 ç§’æ’­æ”¾ä¸‹ä¸€çµ„
            let utterChinese = new SpeechSynthesisUtterance(chinese);
            utterChinese.lang = "zh-TW";
            utterChinese.onend = () => {
              index++;
              setTimeout(playNext, 1000);
            };
            speechSynthesis.speak(utterChinese);
          };
          speechSynthesis.speak(utterKorean);
        } else {
          highlightRow(-1); // æ¸…é™¤æ‰€æœ‰æ¨™ç¤º
        }
      }
      // ç­‰å¾…ä¸€ç§’å¾Œé–‹å§‹æ’­æ”¾
      setTimeout(playNext, 1000);
    }

    function playAllSentenceAudio() {
      if (data.length === 0) {
        alert("è«‹å…ˆä¸Šå‚³ CSV æª”ï¼");
        return;
      }
      let index = 0;
      // å–å¾—æ‰€æœ‰å–®å­—è¡¨çš„ tr
      let rows = document.querySelectorAll("#stats table tbody tr");
      function highlightRow(idx) {
        rows.forEach((tr, i) => {
          if (i === idx) {
            tr.classList.add("playing");
          } else {
            tr.classList.remove("playing");
          }
        });
      }
      function playNext() {
        if (index < data.length) {
          highlightRow(index);
          let sentence = data[index][2];
          let chinese = data[index][3];
          let utterKorean = new SpeechSynthesisUtterance(sentence);
          utterKorean.lang = "ko-KR";
          utterKorean.onend = () => {
            // æ’­æ”¾ä¸­æ–‡ï¼ŒçµæŸå¾Œå†ç­‰ 1 ç§’æ’­æ”¾ä¸‹ä¸€çµ„
            let utterChinese = new SpeechSynthesisUtterance(chinese);
            utterChinese.lang = "zh-TW";
            utterChinese.onend = () => {
              index++;
              setTimeout(playNext, 1000);
            };
            speechSynthesis.speak(utterChinese);
          };
          speechSynthesis.speak(utterKorean);
        } else {
          highlightRow(-1); // æ¸…é™¤æ‰€æœ‰æ¨™ç¤º
        }
      }
      // ç­‰å¾…ä¸€ç§’å¾Œé–‹å§‹æ’­æ”¾
      setTimeout(playNext, 1000);
    }

    function stopAllAudio() {
      speechSynthesis.cancel();
      // æ¸…é™¤å–®å­—è¡¨æ’­æ”¾æ¨™ç¤º
      let rows = document.querySelectorAll("#stats table tbody tr");
      rows.forEach(tr => tr.classList.remove("playing"));
    }

    function updateStats() {
      let curStats = getCurrentStats();
      let accuracy = curStats.total > 0 ? ((curStats.correct / curStats.total) * 100).toFixed(2) : '0.00';
      let modeName = '';
      if (mode === 'reading') modeName = 'é–±è®€æ¸¬é©—';
      else if (mode === 'listening') modeName = 'è½åŠ›æ¸¬é©—';
      else if (mode === 'spelling') modeName = 'æ‹¼å¯«æ¸¬é©—';
      document.getElementById("stats").innerHTML = `
        <h3>${modeName}å­¸ç¿’çµ±è¨ˆ</h3>
        <p>ç­”é¡Œæ•¸ï¼š${curStats.total}</p>
        <p>æ­£ç¢ºç‡ï¼š${accuracy}%</p>
        <p>éŒ¯èª¤å­—å½™ï¼š</p>
        <ul>${Object.entries(curStats.wrongWords).map(([w, c]) => `<li>${w} - ${c} æ¬¡</li>`).join("")}</ul>
      `;
    }

    // åˆ†é ç‹€æ…‹
    let vocabPage = 1;
    const vocabPageSize = 10;

    // è¨˜æ†¶ checkbox èˆ‡é–“éš”ç§’æ•¸
    let vocabSettings = {
      loop: false,
      autoPage: false,
      interval: 0.5
    };

    function showVocabularyList(page = 1) {
      if (data.length === 0) {
        alert("è«‹å…ˆä¸Šå‚³ CSV æª”ï¼");
        return;
      }
      vocabPage = page;
      const totalPages = Math.ceil(data.length / vocabPageSize);
      const startIdx = (vocabPage - 1) * vocabPageSize;
      const endIdx = Math.min(startIdx + vocabPageSize, data.length);
      const pageData = data.slice(startIdx, endIdx);

      // å–ç”¨æš«å­˜è¨­å®š
      let loopChecked = vocabSettings.loop ? 'checked' : '';
      let autoPageChecked = vocabSettings.autoPage ? 'checked' : '';
      let intervalValue = typeof vocabSettings.interval === 'number' ? vocabSettings.interval : 0.5;

      let vocabHtml = `
        <h2>å–®å­—è¡¨</h2>
        <div>
          <button onclick="playAllWordAudio(true)">æ’­æ”¾å–®å­—</button>
          <button onclick="playAllSentenceAudio(true)">æ’­æ”¾ä¾‹å¥</button>
          <button onclick="stopAllAudio()">åœæ­¢æ’­æ”¾</button>
          <div style="margin:10px 0;">
            <label>
              <input type="checkbox" id="loopCheckbox" name="loopCheckbox" ${loopChecked}> å¾ªç’°æ’­æ”¾
            </label>
            <label style="margin-left:10px;">
              <input type="checkbox" id="autoPageCheckbox" name="autoPageCheckbox" ${autoPageChecked}> è‡ªå‹•æ›é 
            </label>
            <label style="margin-left:10px;">
              é–“éš”æ™‚é–“ï¼š
              <input type="number" id="intervalInput" value="${intervalValue}" min="0" style="width:50px;"> ç§’
            </label>
          </div>
        </div>
        <table border="1" cellpadding="5" cellspacing="0">
          <thead>
            <tr>
              <th class="cell-nowrap">éŸ“æ–‡</th>
              <th class="cell-nowrap">ä¸­æ–‡</th>
              <th>éŸ“æ–‡ä¾‹å¥</th>
              <th>ä¸­æ–‡ä¾‹å¥</th>
            </tr>
          </thead>
          <tbody>
            ${pageData.map(row => `
              <tr>
                <td class="cell-nowrap" onclick=\"playWordAudio('${row[0]}')\">${row[0]}</td>
                <td class="cell-nowrap">${row[1]}</td>
                <td onclick=\"playSentenceAudio('${row[2]}')\">${row[2]}</td>
                <td>${row[3]}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
        <div style='padding-top:10px; text-align: center;'>
          <button ${vocabPage === 1 ? 'disabled' : ''} onclick='saveVocabSettings();showVocabularyList(${vocabPage - 1})'>ä¸Šä¸€é </button>
          ç¬¬ ${vocabPage} / ${totalPages} é 
          <button ${vocabPage === totalPages ? 'disabled' : ''} onclick='saveVocabSettings();showVocabularyList(${vocabPage + 1})'>ä¸‹ä¸€é </button>
        </div>
      `;
      document.getElementById("quiz").style.display = "none";
      document.getElementById("stats").innerHTML = vocabHtml;

      // ç¶å®š checkbox èˆ‡ input äº‹ä»¶ï¼Œè®Šå‹•æ™‚å³æ™‚å­˜å…¥æš«å­˜
      setTimeout(() => {
        let loopCheckbox = document.getElementById("loopCheckbox");
        let autoPageCheckbox = document.getElementById("autoPageCheckbox");
        let intervalInput = document.getElementById("intervalInput");
        if (loopCheckbox) loopCheckbox.onchange = saveVocabSettings;
        if (autoPageCheckbox) autoPageCheckbox.onchange = saveVocabSettings;
        if (intervalInput) intervalInput.oninput = saveVocabSettings;
      }, 0);
    }

    // æ›é å‰å…ˆå­˜è¨­å®š
    function saveVocabSettings() {
      let loopCheckbox = document.getElementById("loopCheckbox");
      let autoPageCheckbox = document.getElementById("autoPageCheckbox");
      let intervalInput = document.getElementById("intervalInput");
      vocabSettings.loop = loopCheckbox && loopCheckbox.checked;
      vocabSettings.autoPage = autoPageCheckbox && autoPageCheckbox.checked;
      let val = intervalInput && intervalInput.value ? parseFloat(intervalInput.value) : 0.5;
      vocabSettings.interval = (isNaN(val) || val < 0) ? 0.5 : val;
    }

    // ä¿®æ”¹æ’­æ”¾å…¨éƒ¨å–®å­—/ä¾‹å¥ï¼Œåƒ…æ’¥æ”¾ç•¶å‰é 
    function playAllWordAudio(onlyCurrentPage = false) {
      if (data.length === 0) {
        alert("è«‹å…ˆä¸Šå‚³ CSV æª”ï¼");
        return;
      }
      // æ‰‹æ©Ÿé¦–æ¬¡æ’­æ”¾æ™‚å…ˆæ’­æ”¾ä¸€æ®µæ¥µçŸ­éœéŸ³èªéŸ³ä»¥è§£é–èªéŸ³æ¬Šé™
      if (!window.speechSynthesisUnlocked) {
        let unlockUtter = new SpeechSynthesisUtterance(" ");
        unlockUtter.volume = 0;
        unlockUtter.rate = 10;
        unlockUtter.onend = () => {
          window.speechSynthesisUnlocked = true;
          playAllWordAudio(onlyCurrentPage);
        };
        speechSynthesis.speak(unlockUtter);
        return;
      }
      let pageData, rows;
      let autoPage = false;
      let autoPageCheckbox = document.getElementById("autoPageCheckbox");
      if (autoPageCheckbox) autoPage = autoPageCheckbox.checked;
      if (onlyCurrentPage) {
        const startIdx = (vocabPage - 1) * vocabPageSize;
        const endIdx = Math.min(startIdx + vocabPageSize, data.length);
        pageData = data.slice(startIdx, endIdx);
        // åªé¸å–ç•¶å‰é çš„ tr
        rows = Array.from(document.querySelectorAll("#stats table tbody tr")).slice(0, pageData.length);
      } else {
        pageData = data;
        rows = document.querySelectorAll("#stats table tbody tr");
      }
      let index = 0;
      // å–å¾—å¾ªç’°æ’­æ”¾å‹¾é¸ç‹€æ…‹
      let loop = false;
      let loopCheckbox = document.getElementById("loopCheckbox");
      if (loopCheckbox) loop = loopCheckbox.checked;
      // å–å¾—é–“éš”ç§’æ•¸
      let intervalInput = document.getElementById("intervalInput");
      let intervalSec = intervalInput ? parseFloat(intervalInput.value) : 1;
      if (isNaN(intervalSec) || intervalSec < 0) intervalSec = 1;
      let intervalMs = intervalSec * 1000;
      function highlightRow(idx) {
        rows.forEach((tr, i) => {
          if (i === idx) {
            tr.classList.add("playing");
          } else {
            tr.classList.remove("playing");
          }
        });
      }
      function playNext() {
        if (index < pageData.length) {
          highlightRow(index);
          let word = pageData[index][0];
          let chinese = pageData[index][1];
          let utterKorean = new SpeechSynthesisUtterance(word);
          utterKorean.lang = "ko-KR";
          utterKorean.onend = () => {
            let utterChinese = new SpeechSynthesisUtterance(chinese);
            utterChinese.lang = "zh-TW";
            utterChinese.onend = () => {
              index++;
              setTimeout(playNext, intervalMs);
            };
            speechSynthesis.speak(utterChinese);
          };
          speechSynthesis.speak(utterKorean);
        } else {
          highlightRow(-1);
          // è‡ªå‹•æ›é 
          if (autoPage && onlyCurrentPage) {
            const totalPages = Math.ceil(data.length / vocabPageSize);
            if (vocabPage < totalPages) {
              showVocabularyList(vocabPage + 1);
              setTimeout(() => playAllWordAudio(true), intervalMs + 200);
            } else if (loop) {
              showVocabularyList(1);
              setTimeout(() => playAllWordAudio(true), intervalMs + 200);
            }
            // è‹¥æœ€å¾Œä¸€é ä¸”æœªå‹¾é¸å¾ªç’°å‰‡åœæ­¢
          } else if (loop) {
            index = 0;
            setTimeout(playNext, intervalMs);
          }
        }
      }
      setTimeout(playNext, intervalMs);
    }

    function playAllSentenceAudio(onlyCurrentPage = false) {
      if (data.length === 0) {
        alert("è«‹å…ˆä¸Šå‚³ CSV æª”ï¼");
        return;
      }
      // æ‰‹æ©Ÿé¦–æ¬¡æ’­æ”¾æ™‚å…ˆæ’­æ”¾ä¸€æ®µæ¥µçŸ­éœéŸ³èªéŸ³ä»¥è§£é–èªéŸ³æ¬Šé™
      if (!window.speechSynthesisUnlocked) {
        let unlockUtter = new SpeechSynthesisUtterance(" ");
        unlockUtter.volume = 0;
        unlockUtter.rate = 10;
        unlockUtter.onend = () => {
          window.speechSynthesisUnlocked = true;
          playAllSentenceAudio(onlyCurrentPage);
        };
        speechSynthesis.speak(unlockUtter);
        return;
      }
      let pageData, rows;
      let autoPage = false;
      let autoPageCheckbox = document.getElementById("autoPageCheckbox");
      if (autoPageCheckbox) autoPage = autoPageCheckbox.checked;
      if (onlyCurrentPage) {
        const startIdx = (vocabPage - 1) * vocabPageSize;
        const endIdx = Math.min(startIdx + vocabPageSize, data.length);
        pageData = data.slice(startIdx, endIdx);
        // åªé¸å–ç•¶å‰é çš„ tr
        rows = Array.from(document.querySelectorAll("#stats table tbody tr")).slice(0, pageData.length);
      } else {
        pageData = data;
        rows = document.querySelectorAll("#stats table tbody tr");
      }
      let index = 0;
      // å–å¾—å¾ªç’°æ’­æ”¾å‹¾é¸ç‹€æ…‹
      let loop = false;
      let loopCheckbox = document.getElementById("loopCheckbox");
      if (loopCheckbox) loop = loopCheckbox.checked;
      // å–å¾—é–“éš”ç§’æ•¸
      let intervalInput = document.getElementById("intervalInput");
      let intervalSec = intervalInput ? parseFloat(intervalInput.value) : 1;
      if (isNaN(intervalSec) || intervalSec < 0) intervalSec = 1;
      let intervalMs = intervalSec * 1000;
      function highlightRow(idx) {
        rows.forEach((tr, i) => {
          if (i === idx) {
            tr.classList.add("playing");
          } else {
            tr.classList.remove("playing");
          }
        });
      }
      function playNext() {
        if (index < pageData.length) {
          highlightRow(index);
          let sentence = pageData[index][2];
          let chinese = pageData[index][3];
          let utterKorean = new SpeechSynthesisUtterance(sentence);
          utterKorean.lang = "ko-KR";
          utterKorean.onend = () => {
            let utterChinese = new SpeechSynthesisUtterance(chinese);
            utterChinese.lang = "zh-TW";
            utterChinese.onend = () => {
              index++;
              setTimeout(playNext, intervalMs);
            };
            speechSynthesis.speak(utterChinese);
          };
          speechSynthesis.speak(utterKorean);
        } else {
          highlightRow(-1);
          // è‡ªå‹•æ›é 
          if (autoPage && onlyCurrentPage) {
            const totalPages = Math.ceil(data.length / vocabPageSize);
            if (vocabPage < totalPages) {
              showVocabularyList(vocabPage + 1);
              setTimeout(() => playAllSentenceAudio(true), intervalMs + 200);
            } else if (loop) {
              showVocabularyList(1);
              setTimeout(() => playAllSentenceAudio(true), intervalMs + 200);
            }
            // è‹¥æœ€å¾Œä¸€é ä¸”æœªå‹¾é¸å¾ªç’°å‰‡åœæ­¢
          } else if (loop) {
            index = 0;
            setTimeout(playNext, intervalMs);
          }
        }
      }
      setTimeout(playNext, intervalMs);
    }

    // æ¨£å¼ï¼šæ­£åœ¨æ’­æ”¾çš„ tr
    const style = document.createElement('style');
    style.innerHTML = `.playing { background: #ffe066 !important; }`;
    document.head.appendChild(style);

    // æ¸¬é©—è¨­å®šé ï¼šåˆ†é é¡¯ç¤ºå–®å­—ï¼Œæ”¯æ´å…¨é¸/å–®é¸ï¼Œè¨˜éŒ„å‹¾é¸ç‹€æ…‹
    let settingsPage = 1;
    const settingsPageSize = 10;
    function showSettings(page = 1) {
      if (data.length === 0) {
        alert("è«‹å…ˆä¸Šå‚³ CSV æª”ï¼");
        return;
      }
      settingsPage = page;
      const totalPages = Math.ceil(data.length / settingsPageSize);
      const startIdx = (settingsPage - 1) * settingsPageSize;
      const endIdx = Math.min(startIdx + settingsPageSize, data.length);
      const pageData = data.slice(startIdx, endIdx);
      // å–å¾—å·²å‹¾é¸ index
      let selectedIndexes = getSelectedIndexes() || [];
      // æœ¬é æ‰€æœ‰ index
      let pageIndexes = Array.from({length: endIdx - startIdx}, (_, i) => startIdx + i);
      // åˆ¤æ–·æœ¬é æ˜¯å¦å…¨é¸
      let allChecked = pageIndexes.every(i => selectedIndexes.includes(i));
      let settingsHtml = `
        <h2>æ¸¬é©—è¨­å®š</h2>
        <div style="margin-bottom:10px; color:#666;">
          å‹¾é¸çš„å–®å­—æ‰æœƒå‡ºç¾åœ¨æ¸¬é©—é¡Œç›®ä¸­
          <span style='color:#888; font-size:13px;'>(å…¨éƒ¨æœªå‹¾é¸è¦–ç‚ºå…¨é¸)</span>
        </div>
        <div>
          <label>
            <input type="checkbox" id="selectAllCheckbox" ${allChecked ? 'checked' : ''} onclick="toggleSelectAll(this.checked)"> é¸å–æ‰€æœ‰å–®å­—
          </label>
        </div>
        <table border="1" cellpadding="5" cellspacing="0" style="width:100%;">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAllCheckbox" ${allChecked ? 'checked' : ''} onclick="toggleSelectAllOnPage(this.checked)"></th>
              <th class="cell-nowrap">éŸ“æ–‡</th>
              <th class="cell-nowrap">ä¸­æ–‡</th>
              <th>éŸ“æ–‡ä¾‹å¥</th>
              <th>ä¸­æ–‡ä¾‹å¥</th>
            </tr>
          </thead>
          <tbody>
            ${pageData.map((row, idx) => {
              let globalIdx = startIdx + idx;
              let checked = selectedIndexes.includes(globalIdx) ? 'checked' : '';
              return `<tr>
                <td><input type='checkbox' class='wordCheckboxSetting' data-idx='${globalIdx}' ${checked}></td>
                <td class="cell-nowrap">${row[0]}</td>
                <td class="cell-nowrap">${row[1]}</td>
                <td>${row[2]}</td>
                <td>${row[3]}</td>
              </tr>`;
            }).join("")}
          </tbody>
        </table>
        <div style='padding-top:10px; text-align: center;'>
          <button ${settingsPage === 1 ? 'disabled' : ''} onclick='showSettings(${settingsPage - 1})'>ä¸Šä¸€é </button>
          ç¬¬ ${settingsPage} / ${totalPages} é 
          <button ${settingsPage === totalPages ? 'disabled' : ''} onclick='showSettings(${settingsPage + 1})'>ä¸‹ä¸€é </button>
        </div>
      `;
      document.getElementById("quiz").style.display = "none";
      document.getElementById("stats").innerHTML = settingsHtml;
      // ç¶å®š checkbox äº‹ä»¶
      setTimeout(() => {
        let boxes = document.querySelectorAll('.wordCheckboxSetting');
        boxes.forEach(box => {
          box.onchange = function() {
            let idx = parseInt(this.getAttribute('data-idx'));
            let arr = getSelectedIndexes() || [];
            if (this.checked) {
              if (!arr.includes(idx)) arr.push(idx);
            } else {
              arr = arr.filter(i => i !== idx);
            }
            setSelectedIndexes(arr);
            // æ›´æ–°å…¨é¸ç‹€æ…‹
            let pageIndexes = Array.from({length: endIdx - startIdx}, (_, i) => startIdx + i);
            let allChecked = pageIndexes.every(i => arr.includes(i));
            let selectAll = document.getElementById('selectAllCheckbox');
            if (selectAll) selectAll.checked = allChecked;
          };
        });
      }, 0);


      // å…¨é¸åˆ‡æ›
      window.toggleSelectAll = function(checked) {
        if (checked) {
          // å…¨é¸æ‰€æœ‰ index
          let allIndexes = Array.from({length: data.length}, (_, i) => i);
          setSelectedIndexes(allIndexes);
        } else {
          // æ¸…ç©ºæ‰€æœ‰å‹¾é¸
          setSelectedIndexes([]);
        }
        // æ›´æ–°æœ¬é æ‰€æœ‰ checkbox
        let boxes = document.querySelectorAll('.wordCheckboxSetting');
        boxes.forEach(box => { box.checked = checked; });
      };
      window.toggleSelectAllOnPage = function(checked) {
        let arr = getSelectedIndexes() || [];
        let pageIndexes = Array.from({length: endIdx - startIdx}, (_, i) => startIdx + i);
        if (checked) {
          pageIndexes.forEach(i => { if (!arr.includes(i)) arr.push(i); });
        } else {
          arr = arr.filter(i => !pageIndexes.includes(i));
        }
        setSelectedIndexes(arr);
        // æ›´æ–°æœ¬é æ‰€æœ‰ checkbox
        let boxes = document.querySelectorAll('.wordCheckboxSetting');
        boxes.forEach(box => { box.checked = checked; });
      };
    }
  </script>
</body>
</html>
